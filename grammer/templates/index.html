<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <base href='/grammer/'>

    <title>grammer</title>

    <!-- Bootstrap Core CSS -->
    <link href="static/lib/css/bootstrap.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="static/lib/css/simple-sidebar.css" rel="stylesheet">

    <link rel="stylesheet" href="static/lib/css/keen-dashboards.css">
    <link rel="stylesheet" href="static/lib/css/bootstrap-switch.css">
    <link rel="stylesheet" href="static/lib/css/dc.css">
    <link rel="stylesheet" href="static/css/specific.css" />
    <link rel="stylesheet" href="static/css/jquery.accordion.css">
    <link rel="stylesheet" href="static/css/custom.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

  <div id="wrapper" class='toggled'>

    <!-- Sidebar -->
    <div id="sidebar-wrapper">
      <p class='sidebar_labels'>sidebar</p>
    </div>
    <!-- end sidebar -->

    <!-- Page Content used for sidebar toggle -->
    <div id="page-content-wrapper">

      <!-- main container - required --> 
      <div id='main_container'>

        <!-- this row is - required fluid causes problems --> 
        <div class="row" > 

          <!-- hold_views - holds all views -->
          <div id='hold_views' class="col-lg-12">

            <!-- homepage -->
            <div id='homepage_view' class='row'>

              <h1 id='website_title'> grammer </h1>
              <p class='initial_paragraph'>Upload a matrix as a tab-separated file to obtain a zoomable, reorderable, and searchable clustergram. </p>

            <form id='searchForm' action="{{ url_for('jquery_upload_function') }}" method=post enctype=multipart/form-data>
              <input type=file name=file title='Choose File' onClick="console.log('clicking choose file button')" >
              <input class='btn btn-primary' id='file_upload_button'  type=submit value=Upload>
            </form>

            </div>
            <!-- end homepage -->

            <!-- visualization -->
            <div id='viz_container'>

              <div id='gene_exp_view' class='row'>
                <div id='clust_instruct_container' >
                  <h1 id='viz_website_title' onClick='to_homepage()' >grammer</h1>

                  <div id='viz_gmt_labels'></div>

                  <div class='title_viz_instructs'>About:</div>
                  <div class='viz_instruct_text'> The clustergram can be zoomed into using scroll, reordered using the cluster/rank switch or by clicking row/column labels, and rows can be searched using the search button. </div>

                  <!-- button container -->
                  <div id='button_container'>
                    
                    

                    
                    <div id='toggle_order' class="btn-group" data-toggle="buttons" >
                      <label class="btn btn-primary active prot_class" onclick="ccle_params['order']='clust'; reorder_clust_rank();">
                        <input type="radio" name="options" id="clust_button" autocomplete="off" checked > Cluster
                      </label>
                      <label class="btn btn-primary prot_class" onclick="ccle_params['order']='rank'; reorder_clust_rank();">
                        <input type="radio" name="options" id="rank_button" autocomplete="off" > Rank
                      </label>
                    </div>
                  </div>

                  

                  <!-- input box for gene search -->
                  <div id='gene_search_container' class='row'>
                      <input id='gene_search_box' type="text" class="form-control" placeholder="Input Gene" aria-describedby="sizing-addon2">

                      <div id='gene_search_button' class="btn-group" data-toggle="buttons" >
                        <label id='submit_gene_button' class="btn btn-primary active " onclick="find_gene_in_clust();">
                          <input type="radio" name="options" id="" autocomplete="off" checked > Search
                        </label>
                      </div>
                  </div>

                  <button id='to_homepage' type="submit" class='btn btn-primary buttons' onClick='to_homepage()' >Rerun grammer</button>

                </div>
                <div id='clustergram_container' >
                  <div id='col_title'>columns</div>
                  <div id='clust_and_row_container'>
                    <div id='row_title'>rows</div>

                    <!-- exp div -->
                    <div id='svg_div_exp' class='svg_div' ></div>

                    <!-- tfsub div -->
                    <div id='svg_div_tfsub' class='svg_div' ></div>

                  </div>
                </div>
              </div>
            </div>
            <!-- end visualization -->

          </div> 
          <!-- end single column -->

        </div>
        <!-- end row -->

      </div>
      <!-- end main container -->

    </div>
    <!-- end page content wrapper -->

  </div> 
  <!-- /end wrapper -->

  <footer id='footer_div' class="footer navbar-fixed-bottom">
    <div class="row" > 
      <div class="col-xs-12 footer_section"> 
        <p class="text-muted">grammer is being developed by the <a href="http://icahn.mssm.edu/research/labs/maayan-laboratory">Ma'ayan Lab</a> at the <a href="http://icahn.mssm.edu/">Icahn School of Medicine at Mount Sinai</a>. </p>
      </div>
    </div>
  </footer>

  <!-- Modal -->
  <div id='modal_no_input' class="modal fade" role="dialog" aria-labelledby="gridSystemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="gridSystemModalLabel">Please input genes</h4>
        </div>
        <div class="modal-body">

          <div class="container-fluid">
            <p>Input one human/mouse gene symbol per line. </p>
            <p>For instance:</p> 
            <div>PER1</div>
            <div>SENP3</div>
            <div>TOP2A</div>
            <div>PTPN7</div>
            <div>...</div>

          </div>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <!-- Vendor -->
  <!-- jQuery -->
  <script src="static/lib/js/jquery-1.11.2.min.js"></script>

  <!-- adding jquery links -->
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

  <script src='static/lib/js/jquery.accordion.js'></script>
  <!-- Bootstrap Core JavaScript -->
  <script src="static/lib/js/bootstrap.min.js"></script>
  <script src="static/lib/js/bootstrap-switch.min.js"></script>
  <script src="static/lib/js/crossfilter.js"></script>
  <script src="static/lib/js/d3.js"></script>
  <script src="static/lib/js/dc.js"></script>
  <script src="static/lib/js/queue.js"></script>
  <script src="static/lib/js/keen.min.js"></script>
  <script src="static/lib/js/underscore-min.js"></script>
  <script src="static/lib/js/underscore.strings.js"></script>
  <script src='static/lib/js/blockUI.js'></script>
  <script src='static/lib/js/type_ahead.js'></script>
  <!-- stylized file upload button -->
  <!-- http://gregpike.net/demos/bootstrap-file-input/demo.html -->
  <script type="text/javascript" src="static/lib/js/bootstrap.file-input.js"> </script>
  <script type="text/javascript">
    $('input[type=file]').bootstrapFileInput();
    $('.file-inputs').bootstrapFileInput();
  </script>
  <!-- Clustergram Scripts -->
  <script src='static/js/d3_clustergram.js'></script>
  <script src='static/js/load_local_network.js'></script>

  <script>
  
  // switch to homepage 
  function to_homepage(){
    // switch to homepage 
    // d3.select('#clust_instruct_container').style('display','none');
    // d3.select('#clustergram_container').style('display','none');
    // d3.selectAll('.initial_paragraph').style('display','block');
    // d3.select('#website_title').style('display','block');
    d3.select('#gene_exp_view').style('display','none');
    d3.selectAll('#homepage_view').style('display','block');
  }

  // gene expression view 
  function to_ccle_gene_exp(){

    // swap views 
    d3.selectAll('#homepage_view').style('display','none');
    d3.select('#svg_div_tfsub').style('display','none');
    d3.select('#gene_exp_view').style('display','block');
    d3.select('#svg_div_exp').style('display','block');

    // Define missing zscores for protein types 
    ////////////////////////////////////////////
    missing_z = {
      'ALL':[0,20,25],
      'TF':[],
      'KIN':[],
      'PP':[],
      'ACT':[35,40],
      'DACT':[40],
      'MET':[35,40],
      'DMET':[30,35,40],
      'GPCR':[],
      'IC':[]
    };

    // request_json 
    ccle_params = {};
    ccle_params['gc'] = 'ini';
    ccle_params['cutoff'] = 3.5;
    ccle_params['order'] = 'clust';

    // set global variable for svg type
    select_svg_div = 'svg_div_exp';

    // make a clustergram 
    change_class_clustergram('ALL');

  }
 
  // transcription factor view 
  function tf_sub_all_cl(){

    d3.select('#gene_exp_view').style('display','block');
    d3.selectAll('#homepage_view').style('display','none');
    d3.select('#svg_div_exp').style('display','none');
    d3.select('#svg_div_tfsub').style('display','block');

    console.log('make tfsub clustergram')

    // visualization parameters 
    ccle_params = {};
    // ccle_params['gc'] = 'ini';
    // ccle_params['cutoff'] = 3.5;
    ccle_params['order'] = 'clust';
    
    // load tfsub clustergram 
    ////////////////////////////
    // select current visualization div 
    select_svg_div = 'svg_div_tfsub';  

    load_tfsub_clustergram();

    // // request_json 
    // ccle_params = {};
    // ccle_params['gc'] = 'ini';
    // ccle_params['cutoff'] = 3.5;
    // ccle_params['order'] = 'clust';

    // // make a clustergram 
    // change_class_clustergram('ALL');

  }



function make_tf_viz(){
    // making post 
    /////////////////////////////////
    // manually set url (local - works for local and docker)
    url = '/grammer/'

    // define global variables 
    // initialize protein class 
    var inst_prot_class = 'TF';
    // save global variable 
    glob_prot_class = inst_prot_class;
    viz_type = 'tf_sub';
    inst_zscore_cutoff = 3;

    // request_json 
    req_json = {};
    req_json['viz_type'] = 'tf_sub';
    req_json['name'] = 'SMARCA4';

    // request format 
    var posting = $.post( url, req_json );
    
    // make first clustergram 
    // set up wait message before request is made 
    $.blockUI({ css: { 
            border: 'none', 
            padding: '15px', 
            backgroundColor: '#000', 
            '-webkit-border-radius': '10px', 
            '-moz-border-radius': '10px', 
            opacity: .8, 
            color: '#fff' 
        } });

    // get the visualization json from server 
    posting.done( function( network_data ) { 
      // // global network_data
      // global_network_data = network_data ;
      // // make d3 visualization
      // make_d3_clustergram(network_data)
      // turn off the wait sign 
      console.log(network_data)
      $.unblockUI();
    });
  }



  </script>

<!-- Jquery upload file -->
<script type="text/javascript">

  // display the upload button 
  // prevent the style from changing as scripts are loaded
  d3.select('#searchForm').style('display','block')

  // request clustergram 
  $( "#searchForm" ).submit( function( event ) {

    // stop form from working normally 
    event.preventDefault();
   
   // only upload if there is a file 
   if (d3.select('.file-input-name').empty()==false){


      // // debugger
      // debugger;

      // get data from forms 
      $form = $( this );

      // get formdata
      form_data = new FormData($form[0]);
      console.log(form_data)

      // get the url 
      var url = $form.attr( "action" );

      // set up wait message before request is made 
      $.blockUI({ css: { 
              border: 'none', 
              padding: '15px', 
              backgroundColor: '#000', 
              '-webkit-border-radius': '10px', 
              '-moz-border-radius': '10px', 
              opacity: .8, 
              color: '#fff' 
          } });

      $.ajax({
        url: url,
        type: 'POST',
        data: form_data,
        // Tell jQuery not to process data or worry about content-type.
        cache: false,
        contentType: false,
        processData: false,
        success: function(data) {

          // callback function 
          //////////////////////
          console.log('success')
          console.log(data)
          $.unblockUI();

          // swap views 
          d3.selectAll('#homepage_view').style('display','none');
          d3.select('#svg_div_tfsub').style('display','none');
          d3.select('#gene_exp_view').style('display','block');
          d3.select('#svg_div_exp').style('display','block');

          return false
        },
        error: function(data) {
          // loader.stop();
          // console.log(data);
          console.log('request failed')
        }
      });


   }

  });

</script>


</body>

</html>
